<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floating Ball</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 120px;
            height: 120px;
            overflow: hidden;
            background: transparent;
            -webkit-app-region: no-drag;
        }

        /* Floating animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        /* Antenna bobble animation */
        @keyframes bobble {

            0%,
            100% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }
        }

        /* Blink animation */
        @keyframes blink {

            0%,
            96%,
            100% {
                transform: scaleY(1);
            }

            98% {
                transform: scaleY(0.1);
            }
        }

        #robot-container {
            width: 120px;
            height: 120px;
            cursor: grab;
            user-select: none;
            touch-action: none;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.2));
            transition: transform 0.1s;
        }

        #robot-container:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        #robot-container.floating .robot-body {
            animation: float 3s ease-in-out infinite;
        }

        .antenna-group {
            transform-origin: 100px 35px;
            animation: bobble 2s ease-in-out infinite;
        }

        .robot-eyes {
            transform-origin: center;
            animation: blink 4s infinite;
        }

        /* Click feedback */
        #robot-container.clicked {
            transform: scale(0.9);
        }
    </style>
</head>

<body>
    <div id="robot-container" class="floating">
        <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
            <defs>
                <!-- Body gradient -->
                <radialGradient id="bodyGradient" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse"
                    gradientTransform="translate(70 70) rotate(51.3402) scale(166.433)">
                    <stop stop-color="#EBE3D3" />
                    <stop offset="0.46" stop-color="#D0BB95" />
                    <stop offset="1" stop-color="#9C8865" />
                </radialGradient>

                <!-- Face gradient -->
                <linearGradient id="faceGradient" x1="100" y1="65" x2="100" y2="135" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#4A4238" />
                    <stop offset="1" stop-color="#2D2822" />
                </linearGradient>

                <!-- Eye glow effect -->
                <filter id="glow">
                    <feGaussianBlur stdDeviation="1.5" result="coloredBlur" />
                    <feMerge>
                        <feMergeNode in="coloredBlur" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
            </defs>

            <!-- Robot body group -->
            <g class="robot-body">
                <!-- Antenna -->
                <g class="antenna-group">
                    <line x1="100" y1="40" x2="100" y2="20" stroke="#9C8865" stroke-width="4" stroke-linecap="round" />
                    <circle cx="100" cy="18" r="6" fill="#D0BB95" stroke="#9C8865" stroke-width="2" />
                    <!-- Antenna signal light -->
                    <circle cx="100" cy="18" r="2" fill="#86EFAC">
                        <animate attributeName="opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite" />
                    </circle>
                </g>

                <!-- Ears/Hands -->
                <circle cx="25" cy="100" r="15" fill="#9C8865" />
                <circle cx="175" cy="100" r="15" fill="#9C8865" />

                <!-- Main body -->
                <circle cx="100" cy="100" r="80" fill="url(#bodyGradient)" />

                <!-- Internal highlight -->
                <ellipse cx="100" cy="100" rx="75" ry="75" fill="white" fill-opacity="0.05" />
                <path d="M60 50 Q100 30 140 50" stroke="white" stroke-width="3" stroke-linecap="round"
                    stroke-opacity="0.3" fill="none" />

                <!-- Face screen area -->
                <rect x="50" y="75" width="100" height="60" rx="25" fill="url(#faceGradient)" stroke="#9C8865"
                    stroke-width="2" />

                <!-- Eyes -->
                <g class="robot-eyes">
                    <circle cx="80" cy="105" r="8" fill="#86EFAC" filter="url(#glow)" />
                    <circle cx="120" cy="105" r="8" fill="#86EFAC" filter="url(#glow)" />
                    <!-- Eye highlights -->
                    <circle cx="83" cy="102" r="2.5" fill="white" />
                    <circle cx="123" cy="102" r="2.5" fill="white" />
                </g>

                <!-- Blush -->
                <ellipse cx="65" cy="115" rx="5" ry="3" fill="#FF8ba7" fill-opacity="0.6" />
                <ellipse cx="135" cy="115" rx="5" ry="3" fill="#FF8ba7" fill-opacity="0.6" />

                <!-- Mouth -->
                <path d="M95 112 Q100 115 105 112" stroke="#86EFAC" stroke-width="2" stroke-linecap="round"
                    stroke-opacity="0.5" fill="none" />
            </g>
        </svg>
    </div>

    <script>
        const robot = document.getElementById('robot-container');
        let isDragging = false;
        let dragOffsetX, dragOffsetY; // 鼠标距离窗口左上角的偏移量
        let startScreenX, startScreenY; // 拖拽开始时的屏幕坐标，用于判断是否仅仅是点击
        let hasMoved = false;

        // 获取屏幕坐标的辅助函数
        const getScreenCoords = (e) => {
            if (e.type.startsWith('touch')) {
                return {
                    x: e.touches[0] ? e.touches[0].screenX : (e.changedTouches[0] ? e.changedTouches[0].screenX : 0),
                    y: e.touches[0] ? e.touches[0].screenY : (e.changedTouches[0] ? e.changedTouches[0].screenY : 0)
                };
            }
            return { x: e.screenX, y: e.screenY };
        };

        // 获取窗口内坐标的辅助函数
        const getClientCoords = (e) => {
            if (e.type.startsWith('touch')) {
                return {
                    x: e.touches[0] ? e.touches[0].clientX : 0,
                    y: e.touches[0] ? e.touches[0].clientY : 0
                };
            }
            return { x: e.clientX, y: e.clientY };
        };

        // Mouse down event
        const onMouseDown = (e) => {
            isDragging = true;
            hasMoved = false;
            robot.classList.remove('floating');

            const screenCoords = getScreenCoords(e);
            startScreenX = screenCoords.x;
            startScreenY = screenCoords.y;

            const clientCoords = getClientCoords(e);
            dragOffsetX = clientCoords.x;
            dragOffsetY = clientCoords.y;

            if (e.type === 'mousedown') e.preventDefault();
        };

        // Mouse move event
        const onMouseMove = (e) => {
            if (!isDragging) return;

            // 获取当前鼠标在屏幕上的绝对位置
            const screenCoords = getScreenCoords(e);

            // 计算当前移动距离用于判断是否实际上发生了移动
            const moveDist = Math.hypot(screenCoords.x - startScreenX, screenCoords.y - startScreenY);

            if (moveDist > 5) {
                hasMoved = true;
            }

            // 无论是否判定为拖拽，我们都尝试跟随，或者可以选择只有 hasMoved 为真才移动
            // 为了响应灵敏，我们直接移动，click 判定留给 mouseup
            // 计算窗口的新位置 = 鼠标屏幕坐标 - 鼠标在窗口内的固定偏移
            const newX = Math.round(screenCoords.x - dragOffsetX);
            const newY = Math.round(screenCoords.y - dragOffsetY);

            if (window.noteAPI) {
                window.noteAPI.moveFloatingBall(newX, newY);
            }
        };

        // Mouse up event
        const onMouseUp = (e) => {
            if (!isDragging) return;

            isDragging = false;
            robot.classList.add('floating');
            // 获取结束时的屏幕坐标来再次验证移动距离
            const screenCoords = getScreenCoords(e);

            // 如果没有发生显著移动，视为点击
            if (!hasMoved) {
                // Left click - open quick note
                if (e.button === 0 || e.type === 'touchend') {
                    robot.classList.add('clicked');
                    setTimeout(() => robot.classList.remove('clicked'), 100);

                    if (window.noteAPI) {
                        window.noteAPI.openQuickNote();
                    }
                }
            }
        };

        // Right click - open note manager
        robot.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (window.noteAPI) {
                window.noteAPI.openNoteManager();
            }
        });

        // Bind events
        robot.addEventListener('mousedown', onMouseDown);
        robot.addEventListener('touchstart', onMouseDown, { passive: false });

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('touchmove', onMouseMove, { passive: false });

        window.addEventListener('mouseup', onMouseUp);
        window.addEventListener('touchend', onMouseUp);
    </script>
</body>

</html>