<!DOCTYPE html>
<html class="" lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Orbital Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#D0BB95",
                        "background-light": "#f7f7f6",
                        "background-dark": "#1d1a15",
                        "surface-dark": "#1a2436",
                        "surface-light": "#ffffff"
                    },
                    fontFamily: {
                        display: "Plus Jakarta Sans",
                        body: ["Plus Jakarta Sans", "Noto Sans", "sans-serif"]
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <script>
        // Configure marked for GFM (GitHub Flavored Markdown) with table support
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: false,
            mangle: false
        });
    </script>
    <style>
        /* Custom scrollbar - more visible */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .dark ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Drag handle */
        .drag-handle {
            -webkit-app-region: drag;
        }

        .drag-handle button,
        .drag-handle input {
            -webkit-app-region: no-drag;
        }

        /* Note list item transition */
        .note-item {
            transition: all 0.2s ease;
        }

        /* Markdown preview in detail */
        .prose ul {
            list-style-type: disc;
            padding-left: 1.25rem;
        }

        .prose ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
        }

        .prose blockquote {
            border-left: 4px solid #D0BB95;
            padding-left: 1em;
            margin: 1em 0;
        }

        .prose code {
            background-color: #e2e8f0;
            color: #0f172a;
            padding: 0.25em 0.5em;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            font-weight: 500;
        }

        .dark .prose code {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        .prose pre {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 1.25em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .dark .prose pre {
            background-color: #0f172a;
            border-color: #334155;
        }

        .prose pre code {
            background: none;
            padding: 0;
            color: #0f172a;
            font-weight: 400;
        }

        .dark .prose pre code {
            color: #e2e8f0;
        }

        .prose a {
            color: #D0BB95;
            text-decoration: underline;
        }

        .prose img {
            max-width: 100%;
            border-radius: 8px;
            margin: 0.5em 0;
        }

        .prose h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .prose h2 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .prose h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .prose p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        /* Markdown table styles */
        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
            overflow-x: auto;
            display: block;
        }

        .prose thead {
            background-color: #f1f5f9;
        }

        .dark .prose thead {
            background-color: #1e293b;
        }

        .prose th,
        .prose td {
            border: 1px solid #cbd5e1;
            padding: 0.75em 1em;
            text-align: left;
            white-space: nowrap;
        }

        .dark .prose th,
        .dark .prose td {
            border-color: #334155;
        }

        .prose th {
            font-weight: 600;
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .dark .prose th {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        .prose tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .dark .prose tr:nth-child(even) {
            background-color: #0f172a;
        }

        .prose tr:hover {
            background-color: #f1f5f9;
        }

        .dark .prose tr:hover {
            background-color: #1e293b;
        }

        /* Custom Components: Note & Accordion */
        .custom-note {
            background-color: #fef9c3;
            border-left: 4px solid #facc15;
            padding: 1rem 1.25rem;
            margin: 1.5rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            color: #854d0e;
        }

        .dark .custom-note {
            background-color: #422006;
            border-left-color: #facc15;
            color: #fef08a;
        }

        .custom-accordion {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            margin: 1rem 0;
            overflow: hidden;
            background: #fff;
            transition: all 0.2s ease;
        }

        .dark .custom-accordion {
            border-color: #334155;
            background: #1e293b;
        }

        .custom-accordion summary {
            padding: 0.875rem 1.25rem;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #f8fafc;
            color: #1e293b;
            user-select: none;
        }

        .dark .custom-accordion summary {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .custom-accordion summary::before {
            content: "\e5cc";
            font-family: 'Material Symbols Outlined';
            font-size: 20px;
            transition: transform 0.2s ease;
            color: #94a3b8;
        }

        .custom-accordion[open] summary::before {
            transform: rotate(90deg);
        }

        .custom-accordion .accordion-content {
            padding: 1.25rem;
            border-top: 1px solid #e2e8f0;
        }

        .dark .custom-accordion .accordion-content {
            border-top-color: #334155;
        }

        /* Delete confirmation modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 1.5rem;
            /* 更大的圆角 */
            padding: 2rem;
            max-width: 440px;
            width: 90%;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .dark .modal-content {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Toast Styles */
        #toastContainer {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column-reverse;
            /* Stack upwards */
            gap: 12px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            background: white;
            color: #1e293b;
            padding: 12px 20px;
            border-radius: 9999px;
            /* Pill shape */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            border: 1px solid #f1f5f9;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .dark .toast {
            background: #1e293b;
            color: #f1f5f9;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.info .toast-icon {
            color: #D0BB95;
        }


        /* Resizer styles */
        .resizer {
            width: 4px;
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            z-index: 50;
            position: relative;
        }

        .resizer:hover,
        .resizer.resizing {
            background-color: #D0BB95;
            /* primary color */
        }

        .resizer::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            left: -2px;
            right: -2px;
        }

        /* Batch mode styles */
        .batch-mode .note-item {
            padding-left: 2.5rem;
        }

        .batch-checkbox {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.125rem;
            height: 1.125rem;
            accent-color: #D0BB95;
            cursor: pointer;
            z-index: 10;
        }

        .batch-checkbox:checked {
            background-color: #D0BB95;
        }

        .note-item.selected {
            background-color: rgba(208, 187, 149, 0.1) !important;
            border-color: rgba(208, 187, 149, 0.5) !important;
        }
    </style>
</head>

<body class="bg-transparent flex items-center justify-center min-h-screen p-0 font-display">

    <!-- Main Window Container -->
    <div class="w-full h-screen bg-background-light dark:bg-background-dark overflow-hidden flex flex-col">

        <!-- Header -->
        <header
            class="flex items-center justify-between px-6 py-4 bg-surface-light dark:bg-surface-dark border-b border-slate-200 dark:border-slate-800 shrink-0 select-none drag-handle">
            <div class="flex items-center gap-3">
                <div class="size-8 rounded-lg bg-primary/20 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-[20px]">sticky_note_2</span>
                </div>
                <h1 class="text-slate-900 dark:text-white text-lg font-bold tracking-tight">Orbital Notes</h1>
                <span id="noteCount" class="text-xs text-slate-400 ml-2">(0 notes)</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="btnSettings"
                    class="flex items-center justify-center size-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                    title="Settings">
                    <span class="material-symbols-outlined text-[20px]">settings</span>
                </button>
                <div class="w-px h-4 bg-slate-300 dark:bg-slate-700 mx-1"></div>
                <button id="btnMinimize"
                    class="flex items-center justify-center size-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                    title="Minimize">
                    <span class="material-symbols-outlined text-[20px]">remove</span>
                </button>
                <button id="btnFullscreen"
                    class="flex items-center justify-center size-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                    title="Toggle Fullscreen">
                    <span id="fullscreenIcon" class="material-symbols-outlined text-[20px]">fullscreen</span>
                </button>
                <button id="btnClose"
                    class="flex items-center justify-center size-8 rounded-lg hover:bg-red-500 hover:text-white text-slate-500 dark:text-slate-400 transition-colors">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area: Split View -->
        <div class="flex flex-1 overflow-hidden">

            <!-- Sidebar / List View -->
            <div id="sidebar"
                class="flex flex-col border-r border-slate-200 dark:border-slate-800 bg-background-light dark:bg-[#0c111a]"
                style="width: 360px;">

                <!-- Search & Filters -->
                <div class="p-4 space-y-4">
                    <!-- Search Bar -->
                    <div class="relative group">
                        <div
                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400 group-focus-within:text-primary transition-colors">
                            <span class="material-symbols-outlined text-[20px]">search</span>
                        </div>
                        <input id="searchInput"
                            class="block w-full pl-10 pr-3 py-2.5 rounded-lg bg-white dark:bg-surface-dark border-0 ring-1 ring-slate-200 dark:ring-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-primary focus:outline-none text-sm transition-shadow"
                            placeholder="Search notes..." type="text" />
                    </div>

                    <!-- Filter Chips -->
                    <div id="filterChips" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button
                            class="filter-chip active px-3 py-1.5 rounded-full bg-primary text-white text-xs font-semibold whitespace-nowrap shadow-sm shadow-primary/25"
                            data-tag="all">All Notes</button>
                    </div>
                </div>

                <!-- Batch Mode Header -->
                <div id="batchModeHeader"
                    class="hidden px-4 py-2 bg-primary/10 border-b border-primary/20 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 accent-primary cursor-pointer">
                        <span id="selectedCount" class="text-xs font-medium text-slate-600 dark:text-slate-300">0
                            selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnBatchExport"
                            class="px-3 py-1 text-xs font-medium bg-primary text-white rounded-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">download</span>
                                Export
                            </span>
                        </button>
                        <button id="btnBatchDelete"
                            class="px-3 py-1 text-xs font-medium bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            <span class="flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">delete</span>
                                Delete
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Note List -->
                <div id="noteList" class="flex-1 overflow-y-auto px-3 pb-4 space-y-2">
                    <!-- Notes will be rendered here -->
                </div>

                <!-- New Note Button -->
                <div
                    class="p-4 border-t border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-surface-dark space-y-2">
                    <div class="flex gap-2">
                        <button id="btnNewNote"
                            class="flex flex-1 items-center justify-center gap-2 rounded-lg bg-primary hover:opacity-90 text-white py-2.5 font-bold shadow-lg shadow-primary/20 transition-all active:scale-[0.98]">
                            <span class="material-symbols-outlined text-[20px]">add</span>
                            <span>New Note</span>
                        </button>
                        <button id="btnBatchMode"
                            class="flex items-center justify-center gap-1 px-3 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 py-2.5 font-medium transition-all active:scale-[0.98]"
                            title="Batch operations">
                            <span class="material-symbols-outlined text-[18px]">checklist</span>
                        </button>
                    </div>
                    <button id="btnFetchAINews"
                        class="flex w-full items-center justify-center gap-2 rounded-lg bg-primary hover:opacity-90 text-white py-2.5 font-bold shadow-lg shadow-primary/20 transition-all active:scale-[0.98]">
                        <span class="material-symbols-outlined text-[20px]">newspaper</span>
                        <span id="aiNewsButtonText">AI Daily News</span>
                    </button>
                </div>
            </div>

            <!-- Resizer -->
            <div id="resizer" class="resizer shadow-sm"></div>

            <!-- Detail View -->
            <div id="detailView"
                class="flex-1 flex flex-col bg-surface-light dark:bg-background-dark relative overflow-hidden">

                <!-- Empty State -->
                <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                    <span class="material-symbols-outlined text-[64px] mb-4">description</span>
                    <p class="text-lg font-medium">Select a note to view</p>
                    <p class="text-sm mt-1">or create a new one</p>
                </div>

                <!-- Note Detail (hidden by default) -->
                <div id="noteDetail" class="hidden flex-1 flex flex-col overflow-hidden">
                    <!-- Editor Toolbar -->
                    <div
                        class="flex items-center justify-between px-6 py-3 border-b border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-surface-dark/50 backdrop-blur-sm z-10">
                        <div id="lastEdited" class="text-xs text-slate-500 dark:text-slate-400 font-medium">Last edited
                            --</div>
                        <div class="flex items-center gap-1">
                            <!-- View mode buttons -->
                            <div id="viewModeButtons" class="flex items-center gap-1">
                                <button id="btnPinNote"
                                    class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                                    title="Pin Note">
                                    <span class="material-symbols-outlined text-[20px]">keep</span>
                                </button>
                                <button id="btnCopyNote"
                                    class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                                    title="Copy to Clipboard">
                                    <span class="material-symbols-outlined text-[20px]">content_copy</span>
                                </button>
                                <!-- Export Button with Dropdown -->
                                <div class="relative">
                                    <button id="btnExportNote"
                                        class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                                        title="Export Note">
                                        <span class="material-symbols-outlined text-[20px]">download</span>
                                    </button>
                                    <!-- Export Menu -->
                                    <div id="exportMenu"
                                        class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-surface-dark rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden z-50">
                                        <button data-format="markdown"
                                            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
                                            <span class="material-symbols-outlined text-[18px]">description</span>
                                            Export as Markdown
                                        </button>
                                        <button data-format="word"
                                            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
                                            <span class="material-symbols-outlined text-[18px]">article</span>
                                            Export as Word
                                        </button>
                                        <button data-format="pdf"
                                            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
                                            <span class="material-symbols-outlined text-[18px]">picture_as_pdf</span>
                                            Export as PDF
                                        </button>
                                    </div>
                                </div>
                                <button id="btnEditNote"
                                    class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                                    title="Edit Note">
                                    <span class="material-symbols-outlined text-[20px]">edit</span>
                                </button>
                                <button id="btnDeleteNote"
                                    class="p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 hover:text-red-500 transition-colors"
                                    title="Delete Note">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </div>
                            <!-- Edit mode buttons -->
                            <div id="editModeButtons" class="hidden flex items-center gap-2">
                                <button id="btnCancelEdit"
                                    class="px-3 py-1.5 text-xs font-medium text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">
                                    Cancel
                                </button>
                                <button id="btnSaveNote"
                                    class="px-4 py-1.5 text-xs font-bold bg-primary text-white rounded-lg shadow-lg shadow-primary/20 hover:opacity-90 transition-all">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="flex-1 overflow-y-auto p-8 flex flex-col min-h-0">
                        <!-- Preview Mode -->
                        <div id="viewArea">
                            <h1 id="noteTitle" class="text-3xl font-bold text-slate-900 dark:text-white mb-4">Note Title
                            </h1>
                            <div id="noteTags" class="flex gap-2 mb-4">
                                <!-- Tags will be rendered here -->
                            </div>
                            <div id="noteContent"
                                class="prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300">
                                <!-- Content will be rendered here -->
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="editArea" class="hidden h-full flex flex-col space-y-4">
                            <input id="editTitle" type="text"
                                class="w-full text-2xl font-bold bg-transparent border-0 border-b-2 border-slate-200 dark:border-slate-800 focus:border-primary dark:focus:border-primary focus:ring-0 px-0 py-2 text-slate-900 dark:text-white transition-colors"
                                placeholder="Note Title">

                            <input id="editTags" type="text"
                                class="w-full bg-slate-100 dark:bg-slate-800 border-0 rounded-lg px-3 py-2 text-sm text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-primary focus:outline-none transition-shadow"
                                placeholder="Tags (comma separated)">

                            <textarea id="editContent"
                                class="flex-1 w-full bg-transparent border-0 focus:ring-0 p-0 text-slate-600 dark:text-slate-300 resize-none min-h-[300px]"
                                placeholder="Start writing..."></textarea>
                        </div>
                    </div>

                    <!-- Footer / Status Bar -->
                    <div
                        class="px-6 py-2 border-t border-slate-200 dark:border-slate-800 flex justify-between items-center bg-surface-light dark:bg-surface-dark text-[11px] text-slate-400">
                        <div class="flex items-center gap-2">
                            <span class="flex size-2 bg-green-500 rounded-full"></span>
                            <span id="statusText">Saved</span>
                        </div>
                        <div id="wordCount">0 words</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content dark:bg-surface-dark w-[500px] max-w-[90%] flex flex-col h-[500px]">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">Settings</h3>
                <button id="btnCloseSettings" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4">
                <button
                    class="settings-tab active px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary transition-colors"
                    data-tab="general">General</button>
                <button
                    class="settings-tab px-4 py-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors"
                    data-tab="shortcuts">Shortcuts</button>
                <button
                    class="settings-tab px-4 py-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors"
                    data-tab="tags">Tags</button>
                <button
                    class="settings-tab px-4 py-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors"
                    data-tab="dify">Dify</button>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-1">
                <!-- General Tab -->
                <div id="tabGeneral" class="tab-content space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Data Storage
                            Path</label>
                        <div class="flex gap-2">
                            <input id="dataPathInput" readonly type="text"
                                class="flex-1 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-sm text-slate-600 dark:text-slate-300 px-3 py-2">
                            <button id="btnBrowsePath"
                                class="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-sm font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Browse</button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">Requires restart to apply changes.</p>
                    </div>

                    <div class="pt-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                            Floating Ball Size: <span id="sizeValue" class="text-primary font-bold">120</span>px
                        </label>
                        <input id="sizeInput" type="range" min="40" max="240" step="10" value="120"
                            class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                            <span>Small (40px)</span>
                            <span>Large (240px)</span>
                        </div>
                    </div>

                </div>

                <!-- Shortcuts Tab -->
                <div id="tabShortcuts" class="tab-content hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Toggle Floating
                            Ball</label>
                        <input id="shortcutInput" type="text" placeholder="Click to record (e.g. Alt+1)"
                            class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent px-3 py-2">
                        <p class="text-xs text-slate-400 mt-1">Default: Alt+1</p>
                    </div>
                </div>

                <!-- Tags Tab -->
                <div id="tabTags" class="tab-content hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Existing
                            Tags</label>
                        <div id="settingsTagList" class="flex flex-wrap gap-2">
                            <!-- Tags will be rendered here -->
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Click X to delete a tag from the system (removes from
                            filter list only).</p>
                    </div>
                </div>

                <!-- Dify Tab -->
                <div id="tabDify" class="tab-content hidden space-y-4">
                    <div class="space-y-4">
                        <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                            <span class="material-symbols-outlined text-[18px]">api</span>
                            Dify Workflow Configuration
                        </h4>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Base URL
                                </label>
                                <input id="difyBaseUrlInput" type="text" placeholder="https://api.dify.ai/v1"
                                    class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm text-slate-600 dark:text-slate-300 px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <p class="text-xs text-slate-400 mt-1">Dify API base URL (leave empty to use .env)</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                                    Workflow API Key
                                </label>
                                <input id="difyApiKeyInput" type="password" placeholder="app-xxxxxxxxxxxxxx"
                                    class="w-full rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm text-slate-600 dark:text-slate-300 px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <p class="text-xs text-slate-400 mt-1">Workflow API key (leave empty to use .env)</p>
                            </div>
                        </div>

                        <div
                            class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800/30">
                            <p class="text-xs text-blue-600 dark:text-blue-400 leading-relaxed">
                                <span class="font-bold">Note:</span> These settings are used for the AI Daily News
                                feature. You can find your API key in the Dify Workflow "API Access" section.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                <button id="btnCancelSettings"
                    class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Cancel</button>
                <button id="btnSaveSettings"
                    class="px-4 py-2 rounded-lg bg-primary text-white hover:opacity-90 transition-opacity">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content dark:bg-surface-dark">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Delete Note</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Are you sure you want to delete this note? This action
                cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="btnCancelDelete"
                    class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Cancel</button>
                <button id="btnConfirmDelete"
                    class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <!-- Batch Export Modal -->
    <div id="batchExportModal" class="modal-overlay">
        <div class="modal-content dark:bg-surface-dark">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Export Notes</h3>
            <p id="batchExportInfo" class="text-slate-600 dark:text-slate-300 mb-4">Export 0 selected notes</p>

            <div class="space-y-2 mb-6">
                <button data-format="markdown"
                    class="batch-format-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-3">
                    <span class="material-symbols-outlined text-[24px] text-slate-500">description</span>
                    <div>
                        <div class="font-medium text-slate-700 dark:text-slate-200">Markdown (.md)</div>
                        <div class="text-xs text-slate-400">Plain text, preserves formatting</div>
                    </div>
                </button>
                <button data-format="word"
                    class="batch-format-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-3">
                    <span class="material-symbols-outlined text-[24px] text-slate-500">article</span>
                    <div>
                        <div class="font-medium text-slate-700 dark:text-slate-200">Word (.docx)</div>
                        <div class="text-xs text-slate-400">Editable document format</div>
                    </div>
                </button>
                <button data-format="pdf"
                    class="batch-format-btn w-full text-left px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-primary hover:bg-primary/5 transition-all flex items-center gap-3">
                    <span class="material-symbols-outlined text-[24px] text-slate-500">picture_as_pdf</span>
                    <div>
                        <div class="font-medium text-slate-700 dark:text-slate-200">PDF (.pdf)</div>
                        <div class="text-xs text-slate-400">Best for sharing and printing</div>
                    </div>
                </button>
            </div>

            <div class="flex justify-end gap-3">
                <button id="btnCancelBatchExport"
                    class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Batch Delete Confirmation Modal -->
    <div id="batchDeleteModal" class="modal-overlay">
        <div class="modal-content dark:bg-surface-dark">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Delete Notes</h3>
            <p id="batchDeleteInfo" class="text-slate-600 dark:text-slate-300 mb-4">Are you sure you want to delete 0
                selected notes?</p>
            <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-800/30 mb-6">
                <p class="text-sm text-red-600 dark:text-red-400 leading-relaxed">
                    <span class="font-bold">⚠️ Warning:</span> This action cannot be undone. All selected notes and
                    their associated images will be permanently deleted.
                </p>
            </div>
            <div class="flex justify-end gap-3">
                <button id="btnCancelBatchDelete"
                    class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">Cancel</button>
                <button id="btnConfirmBatchDelete"
                    class="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">Delete
                    All</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let notes = [];
        let allTags = [];
        let selectedNoteId = null;
        let currentFilter = 'all';
        let searchQuery = '';
        let isBatchMode = false;
        let selectedNoteIds = new Set();

        // DOM Elements
        const noteList = document.getElementById('noteList');
        const noteDetail = document.getElementById('noteDetail');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const filterChips = document.getElementById('filterChips');
        const deleteModal = document.getElementById('deleteModal');
        const viewArea = document.getElementById('viewArea');
        const editArea = document.getElementById('editArea');
        const viewModeButtons = document.getElementById('viewModeButtons');
        const editModeButtons = document.getElementById('editModeButtons');
        const batchModeHeader = document.getElementById('batchModeHeader');
        const batchExportModal = document.getElementById('batchExportModal');
        const batchDeleteModal = document.getElementById('batchDeleteModal');

        let isEditMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle external links robustly
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href || href.startsWith('#')) return;

                // If it's an external link or a "pretend" relative link that's actually external
                if (href.startsWith('http') || href.includes('.') || href.includes('://')) {
                    e.preventDefault();
                    let url = href;
                    // If it looks like a domain but missing protocol, add it
                    if (!href.includes('://') && !href.startsWith('mailto:')) {
                        url = 'https://' + href;
                    }
                    window.noteAPI?.openExternal(url);
                }
            });

            await loadNotes();


            // Listen for updates
            if (window.noteAPI) {
                window.noteAPI.onNotesUpdated(async () => {
                    await loadNotes();
                });
            }

            // Sidebar Resizer Logic
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebar');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                // Disable pointer events on iframe/other content to prevent interference
                document.body.style.userSelect = 'none';

                // Track mouse movement
                const onMouseMove = (moveEvent) => {
                    if (!isResizing) return;

                    const minWidth = window.innerWidth / 5;
                    const maxWidth = window.innerWidth * 0.8;
                    let newWidth = moveEvent.clientX;

                    if (newWidth < minWidth) newWidth = minWidth;
                    if (newWidth > maxWidth) newWidth = maxWidth;

                    sidebar.style.width = `${newWidth}px`;
                };

                const onMouseUp = () => {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.body.style.cursor = 'default';
                    document.body.style.userSelect = 'auto';

                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });

        // Load notes
        async function loadNotes() {
            if (!window.noteAPI) return;

            notes = await window.noteAPI.getNotes();
            allTags = await window.noteAPI.getAllTags();

            document.getElementById('noteCount').textContent = `(${notes.length} notes)`;

            renderFilterChips();
            renderNoteList();

            // Re-select current note if still exists
            if (selectedNoteId) {
                const stillExists = notes.find(n => n.id === selectedNoteId);
                if (stillExists) {
                    showNoteDetail(stillExists);
                } else {
                    selectedNoteId = null;
                    hideNoteDetail();
                }
            }
        }

        // Render filter chips
        function renderFilterChips() {
            filterChips.innerHTML = `
            <button class="filter-chip ${currentFilter === 'all' ? 'bg-primary text-white shadow-sm shadow-primary/25' : 'bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'} px-3 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition-colors" data-tag="all">All Notes</button>
        `;

            allTags.forEach(tag => {
                const isActive = currentFilter === tag;
                const chip = document.createElement('button');
                chip.className = `filter-chip ${isActive ? 'bg-primary text-white shadow-sm shadow-primary/25' : 'bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'} px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-colors`;
                chip.dataset.tag = tag;
                chip.textContent = tag.charAt(0).toUpperCase() + tag.slice(1);
                filterChips.appendChild(chip);
            });

            // Add click handlers
            filterChips.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', async () => {
                    currentFilter = chip.dataset.tag;
                    renderFilterChips();
                    await filterNotes();
                });
            });
        }

        // Filter notes
        async function filterNotes() {
            if (!window.noteAPI) return;

            if (currentFilter === 'all') {
                if (searchQuery) {
                    notes = await window.noteAPI.searchNotes(searchQuery);
                } else {
                    notes = await window.noteAPI.getNotes();
                }
            } else {
                notes = await window.noteAPI.filterByTag(currentFilter);
                if (searchQuery) {
                    const lowerQuery = searchQuery.toLowerCase();
                    notes = notes.filter(note =>
                        note.title.toLowerCase().includes(lowerQuery) ||
                        note.content.toLowerCase().includes(lowerQuery)
                    );
                }
            }

            renderNoteList();
        }

        // Search handler
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                searchQuery = e.target.value.trim();
                await filterNotes();
            }, 300);
        });

        // Render note list
        function renderNoteList() {
            // Sort: pinned first, then by updatedAt
            const sortedNotes = [...notes].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });

            // Apply batch-mode class to noteList container
            if (isBatchMode) {
                noteList.classList.add('batch-mode');
            } else {
                noteList.classList.remove('batch-mode');
            }

            noteList.innerHTML = sortedNotes.map(note => {
                const isActive = note.id === selectedNoteId && !isBatchMode;
                const isSelected = selectedNoteIds.has(note.id);
                const timeAgo = getTimeAgo(note.updatedAt);
                const preview = note.content.replace(/[#*`\[\]]/g, '').substring(0, 100);
                const tag = note.tags[0] || '';

                return `
                <div class="note-item group relative p-3 rounded-lg ${isActive ? 'bg-white dark:bg-surface-dark border border-primary/30 shadow-sm' : isSelected ? 'selected bg-primary/10 border border-primary/30' : 'bg-transparent hover:bg-white dark:hover:bg-surface-dark border border-transparent hover:border-slate-200 dark:hover:border-slate-700'} cursor-pointer transition-all" data-id="${note.id}">
                    ${isBatchMode ? `
                        <input type="checkbox" class="batch-checkbox" data-id="${note.id}" ${isSelected ? 'checked' : ''}>
                    ` : ''}
                    ${isActive && !isBatchMode ? `
                        <div class="absolute right-3 top-3 opacity-100 transition-opacity">
                            <span class="material-symbols-outlined text-[16px] text-primary">edit_note</span>
                        </div>
                    ` : !isBatchMode ? `
                        <div class="absolute right-3 top-3 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                            <button class="pin-btn text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" data-id="${note.id}">
                                <span class="material-symbols-outlined text-[18px]">${note.pinned ? 'keep_off' : 'push_pin'}</span>
                            </button>
                        </div>
                    ` : ''}
                    <div class="flex items-start gap-3">
                        <div class="mt-1 size-2 rounded-full ${note.pinned ? 'bg-primary' : 'bg-transparent'} shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm ${isActive ? 'font-semibold text-slate-900 dark:text-white' : 'font-medium text-slate-700 dark:text-slate-200'} truncate pr-6">${escapeHtml(note.title)}</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-500 mt-1 line-clamp-2 leading-relaxed">${escapeHtml(preview)}...</p>
                            <div class="mt-2 flex items-center gap-2">
                                ${tag ? `<span class="text-[10px] text-slate-400 bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">${escapeHtml(tag)}</span>` : ''}
                                <span class="text-[10px] text-slate-400">${timeAgo}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Add click handlers
            noteList.querySelectorAll('.note-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Don't select if clicking pin button or checkbox
                    if (e.target.closest('.pin-btn')) return;
                    if (e.target.classList.contains('batch-checkbox')) return;

                    const noteId = item.dataset.id;

                    if (isBatchMode) {
                        // Toggle selection in batch mode
                        if (selectedNoteIds.has(noteId)) {
                            selectedNoteIds.delete(noteId);
                        } else {
                            selectedNoteIds.add(noteId);
                        }
                        updateBatchSelection();
                        renderNoteList();
                    } else {
                        const note = notes.find(n => n.id === noteId);
                        if (note) {
                            selectedNoteId = noteId;
                            showNoteDetail(note);
                            renderNoteList();
                        }
                    }
                });
            });

            // Add checkbox handlers for batch mode
            noteList.querySelectorAll('.batch-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    const noteId = checkbox.dataset.id;
                    if (checkbox.checked) {
                        selectedNoteIds.add(noteId);
                    } else {
                        selectedNoteIds.delete(noteId);
                    }
                    updateBatchSelection();
                    // Update item style without full re-render
                    const item = checkbox.closest('.note-item');
                    if (checkbox.checked) {
                        item.classList.add('selected', 'bg-primary/10', 'border-primary/30');
                        item.classList.remove('bg-transparent', 'border-transparent');
                    } else {
                        item.classList.remove('selected', 'bg-primary/10', 'border-primary/30');
                        item.classList.add('bg-transparent', 'border-transparent');
                    }
                });
            });

            // Add pin button handlers
            noteList.querySelectorAll('.pin-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const noteId = btn.dataset.id;
                    if (window.noteAPI) {
                        await window.noteAPI.togglePin(noteId);
                    }
                });
            });
        }

        // Update batch selection UI
        function updateBatchSelection() {
            const count = selectedNoteIds.size;
            document.getElementById('selectedCount').textContent = `${count} selected`;
            document.getElementById('btnBatchExport').disabled = count === 0;
            document.getElementById('btnBatchDelete').disabled = count === 0;

            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const sortedNotes = [...notes].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
            selectAllCheckbox.checked = sortedNotes.length > 0 && count === sortedNotes.length;
            selectAllCheckbox.indeterminate = count > 0 && count < sortedNotes.length;
        }

        // Enter batch mode
        function enterBatchMode() {
            isBatchMode = true;
            selectedNoteIds.clear();
            batchModeHeader.classList.remove('hidden');

            // Update toggle button style
            const btnBatchMode = document.getElementById('btnBatchMode');
            btnBatchMode.classList.add('bg-primary', 'text-white');
            btnBatchMode.classList.remove('bg-slate-100', 'dark:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');

            updateBatchSelection();
            renderNoteList();
        }

        // Exit batch mode
        function exitBatchMode() {
            isBatchMode = false;
            selectedNoteIds.clear();
            batchModeHeader.classList.add('hidden');

            // Restore toggle button style
            const btnBatchMode = document.getElementById('btnBatchMode');
            btnBatchMode.classList.remove('bg-primary', 'text-white');
            btnBatchMode.classList.add('bg-slate-100', 'dark:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');

            renderNoteList();
        }

        // Show note detail
        function showNoteDetail(note) {
            exitEditMode(); // Always start in view mode
            emptyState.classList.add('hidden');
            noteDetail.classList.remove('hidden');

            document.getElementById('noteTitle').textContent = note.title;

            // Pre-process custom tags to allow markdown parsing inside them
            let content = note.content;

            // Convert <Note>...</Note>
            content = content.replace(/<Note>([\s\S]*?)<\/Note>/gi, (match, p1) => {
                return `<div class="custom-note">${p1}</div>`;
            });

            // Convert <Accordion title="...">...</Accordion>
            content = content.replace(/<Accordion\s+title="([^"]+)">([\s\S]*?)<\/Accordion>/gi, (match, title, p1) => {
                return `<details class="custom-accordion"><summary>${title}</summary><div class="accordion-content">${p1}</div></details>`;
            });

            document.getElementById('noteContent').innerHTML = marked.parse(content);
            document.getElementById('lastEdited').textContent = `Last edited ${getTimeAgo(note.updatedAt)}`;
            document.getElementById('wordCount').textContent = `${countWords(note.content)} words`;

            // Render tags
            const noteTags = document.getElementById('noteTags');
            noteTags.innerHTML = note.tags.map(tag =>
                `<span class="text-xs text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">#${escapeHtml(tag)}</span>`
            ).join('');

            // Update pin button
            const pinBtn = document.getElementById('btnPinNote');
            pinBtn.querySelector('span').textContent = note.pinned ? 'keep_off' : 'keep';
        }

        // Hide note detail
        function hideNoteDetail() {
            emptyState.classList.remove('hidden');
            noteDetail.classList.add('hidden');
        }

        // Window controls
        document.getElementById('btnClose').addEventListener('click', () => {
            window.noteAPI?.closeWindow();
        });

        document.getElementById('btnMinimize').addEventListener('click', () => {
            window.noteAPI?.minimizeWindow();
        });

        document.getElementById('btnFullscreen').addEventListener('click', () => {
            window.noteAPI?.toggleMaximize();
            // Toggle icon between fullscreen and fullscreen_exit
            const icon = document.getElementById('fullscreenIcon');
            if (icon.textContent === 'fullscreen') {
                icon.textContent = 'fullscreen_exit';
            } else {
                icon.textContent = 'fullscreen';
            }
        });

        // New note button
        document.getElementById('btnNewNote').addEventListener('click', () => {
            window.noteAPI?.openQuickNote();
        });

        // Edit note button
        document.getElementById('btnEditNote').addEventListener('click', () => {
            const note = notes.find(n => n.id === selectedNoteId);
            if (note) {
                enterEditMode(note);
            }
        });

        // Cancel edit button
        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            exitEditMode();
        });

        // Save note button
        document.getElementById('btnSaveNote').addEventListener('click', async () => {
            if (!selectedNoteId || !window.noteAPI) return;

            const title = document.getElementById('editTitle').value.trim() || 'Untitled';
            const tagsText = document.getElementById('editTags').value.trim();
            const tags = tagsText ? tagsText.split(',').map(t => t.trim()).filter(t => t) : [];
            const content = document.getElementById('editContent').value;

            const updatedNote = await window.noteAPI.updateNote(selectedNoteId, {
                title,
                tags,
                content
            });

            if (updatedNote) {
                // The notes-updated listener will handle the list refresh
                // But we should update our local view immediately for better UX
                const index = notes.findIndex(n => n.id === selectedNoteId);
                if (index !== -1) notes[index] = updatedNote;

                exitEditMode();
                showNoteDetail(updatedNote);
            }
        });

        function enterEditMode(note) {
            isEditMode = true;
            viewArea.classList.add('hidden');
            editArea.classList.remove('hidden');
            viewModeButtons.classList.add('hidden');
            editModeButtons.classList.remove('hidden');

            document.getElementById('editTitle').value = note.title;
            document.getElementById('editTags').value = note.tags.join(', ');
            document.getElementById('editContent').value = note.content;

            // Focus content
            document.getElementById('editContent').focus();
        }

        function exitEditMode() {
            isEditMode = false;
            viewArea.classList.remove('hidden');
            editArea.classList.add('hidden');
            viewModeButtons.classList.remove('hidden');
            editModeButtons.classList.add('hidden');
        }

        // Copy note button
        document.getElementById('btnCopyNote').addEventListener('click', async () => {
            const note = notes.find(n => n.id === selectedNoteId);
            if (note) {
                try {
                    await navigator.clipboard.writeText(note.content);
                    const btn = document.getElementById('btnCopyNote');
                    const icon = btn.querySelector('span');
                    icon.textContent = 'check';
                    setTimeout(() => {
                        icon.textContent = 'content_copy';
                    }, 1000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            }
        });

        // Export note button and menu
        const btnExportNote = document.getElementById('btnExportNote');
        const exportMenu = document.getElementById('exportMenu');

        // Toggle export menu
        btnExportNote.addEventListener('click', (e) => {
            e.stopPropagation();
            exportMenu.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!exportMenu.classList.contains('hidden') &&
                !exportMenu.contains(e.target) &&
                e.target !== btnExportNote) {
                exportMenu.classList.add('hidden');
            }
        });

        // Handle export format selection
        exportMenu.querySelectorAll('button[data-format]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const format = btn.dataset.format;
                exportMenu.classList.add('hidden');

                if (!selectedNoteId || !window.noteAPI) return;

                try {
                    // Show loading state
                    const icon = btnExportNote.querySelector('span');
                    const originalIcon = icon.textContent;
                    icon.textContent = 'hourglass_empty';

                    const result = await window.noteAPI.exportNote(selectedNoteId, format);

                    if (result.success) {
                        // Show success
                        icon.textContent = 'check';
                        setTimeout(() => {
                            icon.textContent = originalIcon;
                        }, 1500);
                    } else if (!result.canceled) {
                        throw new Error(result.error || 'Export failed');
                    } else {
                        icon.textContent = originalIcon;
                    }
                } catch (error) {
                    console.error('Export failed:', error);
                    alert(`Export failed: ${error.message}`);
                    btnExportNote.querySelector('span').textContent = 'download';
                }
            });
        });

        // Pin note button
        document.getElementById('btnPinNote').addEventListener('click', async () => {
            if (selectedNoteId && window.noteAPI) {
                await window.noteAPI.togglePin(selectedNoteId);
            }
        });

        // Delete note button
        document.getElementById('btnDeleteNote').addEventListener('click', () => {
            deleteModal.classList.add('show');
        });

        document.getElementById('btnCancelDelete').addEventListener('click', () => {
            deleteModal.classList.remove('show');
        });

        document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
            if (selectedNoteId && window.noteAPI) {
                await window.noteAPI.deleteNote(selectedNoteId);
                selectedNoteId = null;
                hideNoteDetail();
                deleteModal.classList.remove('show');
            }
        });

        // Close modal on overlay click
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('show');
            }
        });

        // ================= Batch Mode Logic =================

        // Toggle batch mode
        document.getElementById('btnBatchMode').addEventListener('click', () => {
            if (isBatchMode) {
                exitBatchMode();
            } else {
                enterBatchMode();
            }
        });

        // Select all checkbox
        document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
            const sortedNotes = [...notes].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });

            if (e.target.checked) {
                sortedNotes.forEach(note => selectedNoteIds.add(note.id));
            } else {
                selectedNoteIds.clear();
            }
            updateBatchSelection();
            renderNoteList();
        });

        // Open batch export modal
        document.getElementById('btnBatchExport').addEventListener('click', () => {
            if (selectedNoteIds.size === 0) return;
            document.getElementById('batchExportInfo').textContent = `Export ${selectedNoteIds.size} selected notes`;
            batchExportModal.classList.add('show');
        });

        // Cancel batch export
        document.getElementById('btnCancelBatchExport').addEventListener('click', () => {
            batchExportModal.classList.remove('show');
        });

        // Close batch export modal on overlay click
        batchExportModal.addEventListener('click', (e) => {
            if (e.target === batchExportModal) {
                batchExportModal.classList.remove('show');
            }
        });

        // Handle batch export format selection
        document.querySelectorAll('.batch-format-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const format = btn.dataset.format;
                if (!format || !window.noteAPI || selectedNoteIds.size === 0) return;

                batchExportModal.classList.remove('show');

                // Show loading state on the button
                const btnBatchExport = document.getElementById('btnBatchExport');
                const originalContent = btnBatchExport.innerHTML;
                btnBatchExport.innerHTML = '<span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px] animate-spin">progress_activity</span>Exporting...</span>';
                btnBatchExport.disabled = true;

                try {
                    const noteIds = Array.from(selectedNoteIds);
                    const result = await window.noteAPI.exportNotesBatch(noteIds, format);

                    if (result.success) {
                        // Show success message
                        if (result.errors && result.errors.length > 0) {
                            showToast(`Exported ${result.count} notes with ${result.errors.length} errors`, 'error');
                        } else {
                            showToast(`Successfully exported ${result.count} notes`, 'success');
                        }

                        // Exit batch mode after successful export
                        exitBatchMode();
                    } else if (!result.canceled) {
                        throw new Error(result.error || 'Export failed');
                    }
                } catch (error) {
                    console.error('Batch export failed:', error);
                    showToast(`Batch export failed: ${error.message}`, 'error');
                } finally {
                    btnBatchExport.innerHTML = originalContent;
                    btnBatchExport.disabled = selectedNoteIds.size === 0;
                }
            });
        });

        // ================= Batch Delete Logic =================

        // Open batch delete confirmation modal
        document.getElementById('btnBatchDelete').addEventListener('click', () => {
            if (selectedNoteIds.size === 0) return;
            document.getElementById('batchDeleteInfo').textContent = `Are you sure you want to delete ${selectedNoteIds.size} selected notes?`;
            batchDeleteModal.classList.add('show');
        });

        // Cancel batch delete
        document.getElementById('btnCancelBatchDelete').addEventListener('click', () => {
            batchDeleteModal.classList.remove('show');
        });

        // Close batch delete modal on overlay click
        batchDeleteModal.addEventListener('click', (e) => {
            if (e.target === batchDeleteModal) {
                batchDeleteModal.classList.remove('show');
            }
        });

        // Confirm batch delete
        document.getElementById('btnConfirmBatchDelete').addEventListener('click', async () => {
            if (!window.noteAPI || selectedNoteIds.size === 0) return;

            batchDeleteModal.classList.remove('show');

            // Show loading state on delete button
            const btnBatchDelete = document.getElementById('btnBatchDelete');
            const originalContent = btnBatchDelete.innerHTML;
            btnBatchDelete.innerHTML = '<span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px] animate-spin">progress_activity</span>Deleting...</span>';
            btnBatchDelete.disabled = true;

            try {
                const noteIds = Array.from(selectedNoteIds);
                let deletedCount = 0;
                const errors = [];

                // Delete each note
                for (const noteId of noteIds) {
                    try {
                        await window.noteAPI.deleteNote(noteId);
                        deletedCount++;
                    } catch (error) {
                        const note = notes.find(n => n.id === noteId);
                        errors.push({ title: note?.title || 'Unknown', error: error.message });
                    }
                }

                // Show result message
                if (errors.length > 0) {
                    showToast(`Deleted ${deletedCount} notes with ${errors.length} errors`, 'error');
                } else {
                    showToast(`Successfully deleted ${deletedCount} notes`, 'success');
                }

                // Exit batch mode and reload notes
                exitBatchMode();
                await loadNotes();
            } catch (error) {
                console.error('Batch delete failed:', error);
                showToast(`Batch delete failed: ${error.message}`, 'error');
            } finally {
                btnBatchDelete.innerHTML = originalContent;
                btnBatchDelete.disabled = selectedNoteIds.size === 0;
            }
        });

        // Fetch AI News button
        const btnFetchAINews = document.getElementById('btnFetchAINews');
        const aiNewsButtonText = document.getElementById('aiNewsButtonText');

        if (btnFetchAINews) {
            btnFetchAINews.addEventListener('click', async () => {
                if (!window.noteAPI) return;

                // Disable button and show loading state
                btnFetchAINews.disabled = true;
                const originalText = aiNewsButtonText.textContent;
                aiNewsButtonText.textContent = '获取中...';
                btnFetchAINews.style.opacity = '0.7';

                try {
                    // Call the API
                    const newNote = await window.noteAPI.fetchAINews();

                    // Success feedback
                    aiNewsButtonText.textContent = '✓ 成功!';
                    setTimeout(() => {
                        aiNewsButtonText.textContent = originalText;
                        btnFetchAINews.style.opacity = '1';
                        btnFetchAINews.disabled = false;
                    }, 2000);

                    // Auto-select the new note
                    await loadNotes();
                    if (newNote && newNote.id) {
                        const note = notes.find(n => n.id === newNote.id);
                        if (note) {
                            showNoteDetail(note);
                        }
                    }
                } catch (error) {
                    console.error('Failed to fetch AI news:', error);

                    // Error feedback
                    aiNewsButtonText.textContent = '✗ 失败';
                    setTimeout(() => {
                        aiNewsButtonText.textContent = originalText;
                        btnFetchAINews.style.opacity = '1';
                        btnFetchAINews.disabled = false;
                    }, 3000);

                    // Show error alert
                    alert(`获取AI新闻失败:\n${error.message || '未知错误'}\n\n请检查:\n1. Dify 服务是否正常运行\n2. .env 配置是否正确\n3. 网络连接是否正常`);
                }
            });
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }

        function countWords(text) {
            // Count Chinese characters and English words
            const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
            const englishWords = (text.match(/[a-zA-Z]+/g) || []).length;
            return chineseChars + englishWords;
        }

        // Show Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');

            // Icons based on type
            const icons = {
                success: 'check_circle',
                error: 'error',
                info: 'info'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="material-symbols-outlined toast-icon">${icons[type]}</span>
                <span>${message}</span>
            `;

            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 400); // Wait for transition
            }, 3000);
        }

        // ================= Settings Logic =================
        const settingsModal = document.getElementById('settingsModal');
        const btnSettings = document.getElementById('btnSettings');
        const btnCloseSettings = document.getElementById('btnCloseSettings');
        const btnCancelSettings = document.getElementById('btnCancelSettings');
        const btnSaveSettings = document.getElementById('btnSaveSettings');
        const settingsTabs = document.querySelectorAll('.settings-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        let currentSettings = { dataPath: '', globalShortcut: '' };

        // Open Settings
        if (btnSettings) {
            btnSettings.addEventListener('click', async () => {
                await loadSettings();
                settingsModal.classList.add('show');
            });
        }

        // Close Settings
        function closeSettings() {
            settingsModal.classList.remove('show');
        }
        [btnCloseSettings, btnCancelSettings].forEach(btn => btn?.addEventListener('click', closeSettings));

        // Close on overlay click
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) closeSettings();
        });

        // Tab Switching
        settingsTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update tabs
                settingsTabs.forEach(t => {
                    t.classList.remove('active', 'text-primary', 'border-b-2', 'border-primary');
                    t.classList.add('text-slate-500', 'dark:text-slate-400');
                });
                tab.classList.add('active', 'text-primary', 'border-b-2', 'border-primary');
                tab.classList.remove('text-slate-500', 'dark:text-slate-400');

                // Update content
                const tabId = tab.dataset.tab;
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.remove('hidden');
            });
        });

        // Load Settings
        async function loadSettings() {
            if (!window.noteAPI) return;
            const settings = await window.noteAPI.getSettings();
            currentSettings = settings;

            // Populate General
            document.getElementById('dataPathInput').value = settings.dataPath;
            document.getElementById('sizeInput').value = settings.floatingBallSize || 120;
            document.getElementById('sizeValue').textContent = settings.floatingBallSize || 120;

            // Populate Dify Configuration
            document.getElementById('difyBaseUrlInput').value = settings.difyBaseUrl || '';
            document.getElementById('difyApiKeyInput').value = settings.difyApiKey || '';

            // Populate Shortcuts
            document.getElementById('shortcutInput').value = settings.globalShortcut || 'Alt+1';

            // Populate Tags
            renderSettingsTags();
        }

        function renderSettingsTags() {
            const list = document.getElementById('settingsTagList');
            if (!allTags || allTags.length === 0) {
                list.innerHTML = '<span class="text-sm text-slate-400">No tags found.</span>';
                return;
            }
            list.innerHTML = allTags.map(tag => `
                <div class="flex items-center gap-1 px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-xs text-slate-600 dark:text-slate-300">
                    <span>#${tag}</span>
                </div>
            `).join('');
        }

        // Browse Path
        document.getElementById('btnBrowsePath').addEventListener('click', async () => {
            if (!window.noteAPI) return;
            const path = await window.noteAPI.selectDirectory();
            if (path) {
                document.getElementById('dataPathInput').value = path;
            }
        });

        // Record Shortcut
        const shortcutInput = document.getElementById('shortcutInput');
        shortcutInput.addEventListener('keydown', (e) => {
            e.preventDefault();
            const keys = [];
            if (e.ctrlKey) keys.push('Ctrl');
            if (e.metaKey) keys.push('Super');
            if (e.altKey) keys.push('Alt');
            if (e.shiftKey) keys.push('Shift');

            let key = e.key;
            if (key === 'Control' || key === 'Alt' || key === 'Shift' || key === 'Meta') return;

            if (key.match(/^[0-9]$/)) key = key;
            else if (key.length === 1) key = key.toUpperCase();

            keys.push(key);
            const shortcut = keys.join('+');
            shortcutInput.value = shortcut;
        });

        // Size Input Live Preview
        document.getElementById('sizeInput').addEventListener('input', (e) => {
            document.getElementById('sizeValue').textContent = e.target.value;
        });

        // Save Settings
        btnSaveSettings.addEventListener('click', async () => {
            if (!window.noteAPI) return;

            const newPath = document.getElementById('dataPathInput').value;
            const newShortcut = document.getElementById('shortcutInput').value;
            const newSize = parseInt(document.getElementById('sizeInput').value);

            // Check Conflict
            if (newShortcut !== currentSettings.globalShortcut) {
                const conflict = await window.noteAPI.checkShortcutConflict(newShortcut);
                if (conflict) {
                    if (!confirm(`Shortcut ${newShortcut} is currently in use or invalid. Do you want to continue?`)) {
                        return;
                    }
                }
            }

            const newDifyBaseUrl = document.getElementById('difyBaseUrlInput').value.trim();
            const newDifyApiKey = document.getElementById('difyApiKeyInput').value.trim();

            const newSettings = {
                dataPath: newPath,
                globalShortcut: newShortcut,
                floatingBallSize: newSize,
                difyBaseUrl: newDifyBaseUrl,
                difyApiKey: newDifyApiKey
            };

            const result = await window.noteAPI.saveSettings(newSettings);
            if (result.restartRequired) {
                showToast('Settings saved. Restarting application...', 'info');
                setTimeout(async () => {
                    await loadNotes();
                }, 1000);
            }

            closeSettings();
        });
    </script>
    <!-- Toast Container -->
    <div id="toastContainer"></div>
</body>

</html>