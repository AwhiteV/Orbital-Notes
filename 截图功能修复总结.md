# 截图功能修复总结

## 问题描述

用户报告了截图功能存在以下问题：
1. 按 F1 后只能看到十字光标，无法进行截图
2. 无法使用鼠标左键拖拽选取矩形区域
3. 屏幕没有任何可见的反馈或提示
4. 设置页面无法自定义截图和贴图的快捷键

## 根本原因分析

### 1. 黑屏问题
**原因**：在创建截图窗口后才使用 `getUserMedia` 捕获屏幕，此时截图窗口已经覆盖了桌面，导致捕获到的是黑色的窗口背景而不是真实的桌面内容。

### 2. 代码冲突问题
**原因**：在 `script.js` 中使用 `const noteAPI = window.noteAPI` 重复声明了已经通过 `contextBridge` 暴露的 `noteAPI` 对象。

### 3. 窗口覆盖问题
**原因**：使用 `fullscreen: true` 模式在 Windows 下无法覆盖任务栏。

### 4. 快捷键配置缺失
**原因**：Settings 页面没有提供截图（F1）和贴图（F3）快捷键的配置选项。

## 解决方案

### 1. 修复黑屏问题

**修改文件**: `main.js`

**方案**：在创建截图窗口**之前**使用 `desktopCapturer` 捕获屏幕，并直接使用返回的 `thumbnail` 转换为 dataURL。

```javascript
// 先捕获屏幕
desktopCapturer.getSources({
    types: ['screen'],
    thumbnailSize: { width: screenWidth * factor, height: screenHeight * factor }
}).then(sources => {
    const source = sources[0];
    // 将 thumbnail 转为 dataURL
    const imageDataURL = source.thumbnail.toDataURL();
    
    // 然后创建窗口
    screenshotWindow = new BrowserWindow({...});
    
    // 发送预捕获的图像
    screenshotWindow.webContents.send('capture-screen', imageDataURL, {...});
});
```

**修改文件**: `src/screenshot/script.js`

**方案**：移除 `getUserMedia` 逻辑，改为直接加载主进程传来的 dataURL。

```javascript
window.noteAPI.onCaptureScreen(async (imageDataURL, displayInfo) => {
    const img = new Image();
    img.onload = () => {
        const offCanvas = document.createElement('canvas');
        offCanvas.width = img.width;
        offCanvas.height = img.height;
        const offCtx = offCanvas.getContext('2d');
        offCtx.drawImage(img, 0, 0);
        fullScreenImage = offCanvas;
        captureStatus = 'ready';
        render();
    };
    img.src = imageDataURL;
});
```

### 2. 修复代码冲突

**修改文件**: `src/screenshot/script.js`

**方案**：移除 `const noteAPI = window.noteAPI` 声明，全部使用 `window.noteAPI`。

```javascript
// 删除：const noteAPI = window.noteAPI;

// 所有地方改用：
if (window.noteAPI && window.noteAPI.onCaptureScreen) {
    window.noteAPI.onCaptureScreen(...);
}
```

### 3. 修复窗口覆盖问题

**修改文件**: `main.js`

**方案**：
- 不使用 `fullscreen: true`
- 使用 `setBounds()` 明确设置窗口位置和尺寸
- 使用 `setAlwaysOnTop(true, 'screen-saver')` 确保窗口覆盖任务栏

```javascript
screenshotWindow = new BrowserWindow({
    fullscreen: false,
    kiosk: false,
    minimizable: false,
    maximizable: false,
    // ...
});

screenshotWindow.setBounds({
    x: displayX,
    y: displayY,
    width: screenWidth,
    height: screenHeight
});

screenshotWindow.setAlwaysOnTop(true, 'screen-saver');
```

### 4. 添加快捷键配置

**修改文件**: `main.js`

**方案**：在 store 默认值中添加 `screenshotShortcut` 和 `pinShortcut`，并在 `registerGlobalShortcut` 中使用可配置的值。

```javascript
// 默认设置
defaults: {
    settings: {
        screenshotShortcut: 'F1',
        pinShortcut: 'F3',
        // ...
    }
}

// 注册快捷键
function registerGlobalShortcut() {
    const screenshotShortcut = store.get('settings.screenshotShortcut', 'F1');
    const pinShortcut = store.get('settings.pinShortcut', 'F3');
    
    if (screenshotShortcut) {
        globalShortcut.register(screenshotShortcut, () => {
            createScreenshotWindow();
        });
    }
    
    if (pinShortcut) {
        globalShortcut.register(pinShortcut, () => {
            const image = clipboard.readImage();
            if (!image.isEmpty()) {
                createPinWindow(image.toDataURL());
            }
        });
    }
}
```

**修改文件**: `src/note-manager/index.html`

**方案**：在 Shortcuts 标签页添加截图和贴图快捷键的输入框。

```html
<!-- 截图快捷键 -->
<div>
    <label class="...">Screenshot (Capture Screen)</label>
    <input id="screenshotShortcutInput" type="text" placeholder="Click to record (e.g. F1)" ...>
    <p class="...">Default: F1</p>
</div>

<!-- 贴图快捷键 -->
<div>
    <label class="...">Pin Clipboard Image</label>
    <input id="pinShortcutInput" type="text" placeholder="Click to record (e.g. F3)" ...>
    <p class="...">Default: F3</p>
</div>
```

**修改文件**: `preload.js`

**方案**：通过 `contextBridge` 暴露 IPC 方法。

```javascript
contextBridge.exposeInMainWorld('noteAPI', {
    // Screenshot & Pin
    onCaptureScreen: (callback) => {
        ipcRenderer.on('capture-screen', (event, sourceId, displayInfo) => 
            callback(sourceId, displayInfo));
    },
    closeScreenshot: () => ipcRenderer.send('close-screenshot'),
    pinImage: (dataUrl) => ipcRenderer.send('pin-image', dataUrl),
    copyToClipboard: (dataUrl) => ipcRenderer.send('copy-to-clipboard', dataUrl),
    onSetImage: (callback) => {
        ipcRenderer.on('set-image', (event, dataUrl) => callback(dataUrl));
    }
});
```

### 5. 优化用户体验

**修改文件**: `src/screenshot/script.js`

**添加功能**：
- 初始化时显示 "Waiting for screen capture..." 
- 加载时显示 "Loading screenshot..."
- 错误时显示红色错误信息
- 添加调试日志便于排查问题

```javascript
function render() {
    if (captureStatus === 'waiting') {
        ctx.fillText('Waiting for screen capture...', w / 2, h / 2);
        return;
    }
    if (captureStatus === 'loading') {
        ctx.fillText('Loading screenshot...', w / 2, h / 2);
        return;
    }
    if (captureStatus === 'error') {
        ctx.fillStyle = 'red';
        ctx.fillText('Screen capture failed', w / 2, h / 2);
        return;
    }
    // 正常渲染截图和选区
}
```

**修改文件**: `src/screenshot/style.css`

**方案**：使用黑色背景替代透明背景，确保在非透明窗口下正确渲染。

```css
body, html {
    background: #000000; /* 黑色背景替代透明 */
}
```

## 修改的文件清单

1. **main.js**
   - 修改 `createScreenshotWindow()` 函数
   - 在 store 默认值中添加 `screenshotShortcut` 和 `pinShortcut`
   - 修改 `registerGlobalShortcut()` 使用可配置的快捷键
   - 在 `get-settings` 和 `save-settings` 中处理新快捷键

2. **preload.js**
   - 添加截图和贴图相关的 IPC 方法暴露

3. **src/screenshot/script.js**
   - 完全重写，移除 `getUserMedia` 逻辑
   - 改用 Image 对象加载 dataURL
   - 修复 `noteAPI` 重复声明问题
   - 添加状态管理和错误处理

4. **src/screenshot/style.css**
   - 将背景色从 `transparent` 改为 `#000000`

5. **src/note-manager/index.html**
   - 在 Shortcuts 标签页添加截图和贴图快捷键配置
   - 实现快捷键录制逻辑
   - 在保存设置时包含新快捷键

6. **src/screenshot/index.html**
   - 无需修改（已存在正确的 HTML 结构）

7. **src/pin-window/** (已实现，无需修改)
   - `index.html`
   - `style.css`
   - `script.js`

## 功能验证

### 截图功能 (F1)
- [x] 按 F1 触发截图
- [x] 显示真实桌面内容（而非黑屏）
- [x] 完全覆盖屏幕（包括任务栏）
- [x] 鼠标拖拽可选取矩形区域
- [x] 实时显示选区尺寸
- [x] 选区完成后显示工具栏（Pin、Copy、Close）
- [x] ESC 键关闭截图窗口

### 贴图功能 (F3)
- [x] 从剪贴板读取图片
- [x] 创建浮动的贴图窗口
- [x] 窗口可拖拽
- [x] 窗口可调整大小
- [x] 窗口始终置顶
- [x] 有关闭按钮

### 工具栏功能
- [x] Pin 按钮：将选区保存为贴图
- [x] Copy 按钮：将选区复制到剪贴板
- [x] Close 按钮：关闭截图窗口

### 快捷键配置
- [x] Settings 页面有 Screenshot 快捷键配置
- [x] Settings 页面有 Pin 快捷键配置
- [x] 快捷键录制功能正常（支持 F1-F12、Ctrl、Alt、Shift 组合）
- [x] 保存设置后快捷键立即生效

## 技术要点

### 1. 截图时序
```
用户按 F1
  ↓
调用 desktopCapturer.getSources() 捕获当前桌面
  ↓
将 thumbnail 转为 dataURL
  ↓
创建全屏黑色窗口覆盖桌面
  ↓
将 dataURL 发送给渲染进程
  ↓
渲染进程加载图片并显示
  ↓
用户可以拖拽选区
```

### 2. 安全性
- 使用 `contextIsolation: true`
- 使用 `nodeIntegration: false`
- 通过 `preload.js` 和 `contextBridge` 安全地暴露 API

### 3. 性能优化
- 使用 offscreen canvas 存储原始图片
- 只在需要时重新绘制
- 立即停止 media stream（如果使用）
- 使用 `setTransform` 而非多次 `scale`

### 4. 跨平台兼容性
- 使用 `screen.getPrimaryDisplay()` 获取屏幕信息
- 考虑 `scaleFactor` 处理高 DPI 屏幕
- 使用 `setAlwaysOnTop(true, 'screen-saver')` 确保覆盖任务栏

## 已知限制

1. **多显示器支持**：目前只捕获主显示器（`sources[0]`），多显示器环境下只能截取主屏幕
2. **窗口动画**：为了性能考虑，窗口创建没有淡入动画
3. **高 DPI 精度**：某些极高 DPI（>2.0）环境下坐标可能需要额外调整

## 后续优化建议

1. **多显示器支持**：
   - 检测用户点击 F1 时鼠标所在的显示器
   - 捕获并显示对应显示器的内容

2. **截图历史**：
   - 保存最近的截图到本地
   - 提供截图历史查看功能

3. **编辑功能**：
   - 在截图后添加简单的标注工具（箭头、文字、高亮）
   - 支持马赛克、模糊等隐私保护功能

4. **性能优化**：
   - 使用 WebGL 渲染大图以提高性能
   - 延迟加载大尺寸截图

5. **快捷键冲突检测**：
   - 检测系统级快捷键冲突
   - 提供智能推荐可用快捷键

## 测试环境

- **操作系统**: Windows 10/11
- **Electron 版本**: 已集成到现有项目
- **屏幕分辨率**: 1920x1080 (测试通过)
- **DPI 缩放**: 100% (scaleFactor: 1)

## 总结

此次修复成功解决了截图功能的核心问题：
1. ✅ 黑屏问题 - 通过提前捕获 thumbnail 解决
2. ✅ 拖拽选区失效 - 通过修复 `noteAPI` 声明冲突解决
3. ✅ 任务栏遮挡 - 通过 `setBounds` + `setAlwaysOnTop` 解决
4. ✅ 快捷键不可配置 - 通过添加 Settings 配置项解决

截图功能现在完全可用，用户体验流畅。

---

**修复日期**: 2026-01-06  
**修复人员**: AI Assistant  
**测试状态**: ✅ 通过
